<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JSONP 客户端</title>
</head>
<body>
  <script>

    // var script = document.createElement('script')
    // script.src = 'http://localhost/jsonp/server.php'
    // document.body.appendChild(script)

    // function aaabbb (data) {
    //   console.log('1111', data)
    // }

    // var script = document.createElement('script')
    // script.src = 'http://localhost/jsonp/server.php'
    // document.body.appendChild(script)

    // function aaabbb (data) {
    //   console.log('2222', data)
    // }


    // 为每一个请求创建一个唯一的函数

    // var funcName = 'haha_' + Date.now() + Math.random().toString().substr(2, 5)

    // var script = document.createElement('script')
    // script.src = 'http://localhost/jsonp/server.php?callback=' + funcName
    // document.body.appendChild(script)

    // window[funcName] = function (data) {
    //   console.log('1111', data)
    // }


    // 封装一个函数   为每一个请求创建一个唯一的函数
    function jsonp (url, params, callback) {

      // 函数名字（通过随机数命名）  substr(2, 5)表示从小数点之后开始截取
      var funcName = 'jsonp_' + Date.now() + Math.random().toString().substr(2, 5)

      // 表示get请求参数需要用&连接起来
      if (typeof params === 'object') {
        var tempArr = []
        for (var key in params) {
          var value = params[key]
          tempArr.push(key + '=' + value)
        }
        params = tempArr.join('&')
      }

      var script = document.createElement('script')

      // script标签只能发送get请求      callback告诉服务端回调函数的名字是什么
      // 把客户端注册的函数名字传给服务端
      script.src = url + '?' + params + '&callback=' + funcName
      document.body.appendChild(script)

      // 声明一个函数
      // window[funcName]是全局的，相当于在window对象下声明了一个函数
      window[funcName] = function (data) {
        callback(data)

        delete window[funcName]
        document.body.removeChild(script)
      }
    }


    // 方法的调用
    jsonp('http://localhost/Ajax/post/jsonp/server.php', { id:1 }, function (res) {
      console.log(res)
    })

    // jsonp('http://localhost/Ajax/post/jsonp/server.php', { id: 2 }, function (res) {
    //   console.log(res)
    // })
  </script>
</body>
</html>
